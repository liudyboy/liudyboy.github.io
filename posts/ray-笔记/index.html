<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.68.3" /><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Ray 笔记 | liudy</title>

    <link rel="stylesheet" href="/css/meme.min.ee60e170cedf90d86c927787e2597360b59802242e3845a7d04834f4b534af2b.css" integrity="sha256-7mDhcM7fkNhskneH4llzYLWYAiQuOEWn0Eg09LU0rys=" />

    
    
        <script src="/js/meme.min.434274bb2302fe029f98d3d29ae57dab1566be565436f52a6dd93089085533c4.js" integrity="sha256-Q0J0uyMC/gKfmNPSmuV9qxVmvlZUNvUqbdkwiQhVM8Q="></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" /></noscript>

    <meta name="author" content="liudy" /><meta name="description" content="本文记录框架 Ray 相关的笔记" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="liudy" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="liudy" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2021-11-19T17:50:39+08:00",
        "dateModified": "2021-12-30T15:30:10+08:00",
        "url": "https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/",
        "headline": "Ray 笔记",
        "description": "本文记录框架 Ray 相关的笔记",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  6552 ,
        "image": ["https://liudyboy.github.io/imgs/raytest1.png","https://liudyboy.github.io/imgs/raytest2.png","https://liudyboy.github.io/imgs/pstrerelaete.png","https://liudyboy.github.io/imgs/idelada.png","https://liudyboy.github.io/imgs/raytest4.png","https://liudyboy.github.io/imgs/process.png","https://liudyboy.github.io/imgs/rayworker.png","https://liudyboy.github.io/imgs/initiray.png","https://liudyboy.github.io/imgs/rutstco.png"],
        "author": {
            "@type": "Person",
            "description": "Viva La Vida",
            "email": "liudy95@126.com",
            "image": "https://liudyboy.github.io/icons/apple-touch-icon.png",
            "url": "https://liudyboy.github.io/",
            "name": "liudy"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)",
        "publisher": {
            "@type": "Organization",
            "name": "liudy",
            "logo": {
                "@type": "ImageObject",
                "url": "https://liudyboy.github.io/icons/apple-touch-icon.png"
            },
            "url": "https://liudyboy.github.io/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://liudyboy.github.io/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />



    



<meta property="og:title" content="Ray 笔记" />
<meta property="og:description" content="本文记录框架 Ray 相关的笔记" />
<meta property="og:url" content="https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/" />
<meta property="og:site_name" content="liudy" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://liudyboy.github.io/imgs/raytest1.png" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2021-11-19T17:50:39&#43;08:00" />
    <meta property="article:modified_time" content="2021-12-30T15:30:10&#43;08:00" />
    
    <meta property="article:section" content="posts" />



     <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
     tex2jax: {
         inlineMath: [['$','$'], ['\\(','\\)']],
         displayMath: [['$$','$$'], ['\[\[','\]\]']],
         processEscapes: true,
         processEnvironments: true,
         skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
         TeX: { equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js"] }
     }
 });

 MathJax.Hub.Queue(function() {
     
     
     
     var all = MathJax.Hub.getAllJax(), i;
     for(i = 0; i < all.length; i += 1) {
         all[i].SourceElement().parentNode.className += ' has-jax';
     }
 });

</script>

<style>
 code.has-jax {
     font: inherit;
     font-size: 100%;
     background: inherit;
     border: inherit;
     color: #515151;
 }
</style>


   
</head>

    <body>
        <div class="container">
            
    <header class="header" data-scroll-header>
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">liudy</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item active"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">文章</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">分类</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">标签</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">关于</span></a>
                </li>
            
        
            
                
                    
                    
                        <li class="menu-item">
                            <a id="theme-switcher" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5l48.8-97.5a18 18 0 0128 0l48.8 97.5 103.4 -34.5a18 18 0 0119.8 19.8l-34.5 103.4l97.5 48.8a18 18 0 010 28l-97.5 48.8 34.5 103.4a18 18 0 01-19.8 19.8l-103.4-34.5-48.8 97.5a18 18 0 01-28 0l-48.8-97.5l-103.4 34.5a18 18 0 01-19.8-19.8l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8-34.5-103.4a18 18 0 0119.8-19.8zM256 128a128 128 0 10.01 0M256 160a96 96 0 10.01 0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412a256 256 0 10154-407a11.5 11.5 0 00-5 20a201.5 201.5 0 01-134 374a11.5 11.5 0 00-15 13"/></svg></a>
                        </li>
                    
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post" data-align="default" data-type="posts" data-toc-num="true">

            <h1 class="post-title">Ray 笔记</h1>

            

            
                <div class="post-description">本文记录框架 Ray 相关的笔记</div>
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2021-11-19T17:50:39&#43;08:00" class="post-meta-item published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;2021.11.19</time>
    
    
        
        <time datetime="2021-12-30T15:30:10&#43;08:00" class="post-meta-item modified"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2021.12.30</time>
    
    
    
        
        
        
            
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/programing/" class="category-link">Programing</a></span>
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;6552</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;14&nbsp;分钟</span>
    
    
        
            
            <span class="post-meta-item busuanzi-page-pv" id="busuanzi_container_page_pv"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon post-meta-icon"><path d="M288 144a110.94 110.94 0 0 0-31.24 5 55.4 55.4 0 0 1 7.24 27 56 56 0 0 1-56 56 55.4 55.4 0 0 1-27-7.24A111.71 111.71 0 1 0 288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35 0 0 0 0 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35 0 0 0 0-29.19zM288 400c-98.65 0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 400 288 400z"/></svg>&nbsp;<span id="busuanzi_value_page_pv"></span></span>
        
    
    
</div>

            

            <nav class="contents">
  <h2 id="contents" class="contents-title">目录</h2><ol class="toc">
    <li><a href="#basis">Basis</a></li>
    <li><a href="#run-test">Run Test</a></li>
    <li><a href="#source-code-note">Source Code Note</a>
      <ol>
        <li><a href="#workerpy">worker.py</a></li>
        <li><a href="#rayinit">@ray.init()</a></li>
        <li><a href="#core_workerh">core_worker.h</a></li>
        <li><a href="#taskspecification-class">TaskSpecification class</a></li>
        <li><a href="#functiondescriptorinterface-class">FunctionDescriptorInterface class</a></li>
        <li><a href="#heading"></a></li>
      </ol>
    </li>
    <li><a href="#gym">gym</a></li>
    <li><a href="#reference">Reference</a></li>
  </ol>
</nav><div class="post-body">
              <h2 id="basis"><a href="#basis" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Basis</h2>
<ol>
<li><strong>Ray runtime:</strong></li>
</ol>
<p>The Ray runtime consists of multiple services/processes started in the background for communication, data transfer, scheduling, and more. The Ray runtime can be started on a laptop, a single server, or multiple servers.</p>
<ol start="2">
<li><strong>Creating an actor</strong></li>
</ol>
<p>An actor is essentially a stateful worker (or a service). When a new actor is instantiated, a new worker is created, and methods of the actor are scheduled on that specific worker and can access and mutate the state of that worker.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@ray.remote</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="n">counter_actor</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p>equivalent to the following:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="n">Counter</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span>

<span class="n">counter_actor</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p>call methods</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@ray.remote</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># Any method of the actor can return multiple object refs.</span>
    <span class="nd">@ray.method</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>

<span class="n">obj_ref1</span><span class="p">,</span> <span class="n">obj_ref2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_ref1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_ref2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></td></tr></table></div>
</div>
</div><h2 id="run-test"><a href="#run-test" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Run Test</h2>
<ol>
<li>test 1</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="nd">@ray.remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;run increment&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">futures</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">futures</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p>结果是只有一个 CPU 在执行任务占用率为 100% . 但是会出现有很多 Ray::IDLE 的进程
<img src="/imgs/raytest1.png" alt="">
感觉直接 <code>@ray.remote(num_cpus=3)</code> 并没有什么效果。且这里的死循环，CPU 占用 100% 并不是单独使用一个 CPU， 而是使用了多个 CPU ， 且使用哪几个 CPU 并不确定一直在变化。</p>
<ol start="2">
<li>test 2</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@ray.remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="c1"># thread1 = myThread(1, &#34;thread1&#34;, 1)</span>
       <span class="c1"># thread1.start()</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;run increment&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

<span class="n">counters</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">]</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><p><img src="/imgs/raytest2.png" alt="">
<img src="/imgs/pstrerelaete.png" alt="">
可知各个执行任务的 worker 进程是由 raylet 进程生成的，生成的 worker 进程的数量等于节点 cpu 的核数。通过 <code>ray.init(num_cpus)</code> 可以控制生成 worker 进程的数量。
<img src="/imgs/idelada.png" alt="">
可看出 IDLE 的 worker 也得占用 73 M 左右的内存</p>
<ol start="3">
<li>test 3</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;task1&#34;</span><span class="p">,</span> <span class="s2">&#34; pid&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="c1">#ray.get(future)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;task2&#34;</span><span class="p">,</span> <span class="s2">&#34; pid&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="c1">#ray.get(future)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;task3&#34;</span><span class="p">,</span> <span class="s2">&#34; pid&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

<span class="n">counters</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">))</span>
</code></pre></td></tr></table></div>
</div>
</div><p><img src="/imgs/raytest4.png" alt="">
输出的结果显示执行整个程序的代码的进程为 <code>python</code> (python test.py) .  该进程的子进程有</p>
<ul>
<li><code>raylet</code> : 执行的是在 <code>/tmp/ray/session**/sockets/</code> 目录下的 raylet 程序 (该目录下还有个 plasma_store 程序)</li>
<li><code>python_2</code>: 执行 <code>/python/ray/_private/log_monitor.py</code></li>
<li><code>python_3</code>: 执行  <code>/python/ray/autoscaler/_private/monitor.py</code></li>
<li><code>gcs_server</code></li>
<li><code>redis-server</code></li>
<li><code>redis-server</code></li>
</ul>
<p>由上可得出其进程关系图为：
<img src="/imgs/process.png" alt=""></p>
<ol start="4">
<li>plot_pong_example.py</li>
</ol>
<p>使用的 actor 个数为 10. 通过分析 ray 输出的 log 文件可得以下信息：</p>
<h2 id="source-code-note"><a href="#source-code-note" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Source Code Note</h2>
<h3 id="workerpy"><a href="#workerpy" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>worker.py</h3>
<p><img src="/imgs/rayworker.png" alt=""></p>
<p>worker has three mode；</p>
<ul>
<li><strong>SCRIPT_MODE:</strong> should be used if this Worker is a driver that is being run as a Python script or interactively in a shell. It will print information about task failures.</li>
<li><strong>WORKER_MODE</strong> should be used if this Worker is not a driver. It will not print information about tasks.</li>
<li><strong>LOCAL_MODE</strong> should be used if this Worker is a driver and if you want to run the driver in a manner equivalent to serial Python for debugging purposes. It will not send remote function calls to the scheduler and will instead execute them in a blocking fashion.</li>
</ul>
<p><strong>Import functions:</strong></p>
<p><code>remote(*args, **kwargs)</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@PublicAPI</span>
<span class="k">def</span> <span class="nf">remote</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Defines a remote function or an actor class.
</span><span class="s2">
</span><span class="s2">    This can be used with no arguments to define a remote function or actor as
</span><span class="s2">    follows:
</span><span class="s2">
</span><span class="s2">    .. code-block:: python
</span><span class="s2">
</span><span class="s2">        @ray.remote
</span><span class="s2">        def f():
</span><span class="s2">            return 1
</span><span class="s2">
</span><span class="s2">        @ray.remote
</span><span class="s2">        class Foo:
</span><span class="s2">            def method(self):
</span><span class="s2">                return 1
</span><span class="s2">
</span><span class="s2">    It can also be used with specific keyword arguments as follows:
</span><span class="s2">
</span><span class="s2">    .. code-block:: python
</span><span class="s2">
</span><span class="s2">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)
</span><span class="s2">        def f():
</span><span class="s2">            return 1, 2
</span><span class="s2">
</span><span class="s2">        @ray.remote(num_cpus=2, resources={&#34;CustomResource&#34;: 1})
</span><span class="s2">        class Foo:
</span><span class="s2">            def method(self):
</span><span class="s2">                return 1
</span><span class="s2">
</span><span class="s2">    Remote task and actor objects returned by @ray.remote can also be
</span><span class="s2">    dynamically modified with the same arguments as above using
</span><span class="s2">    ``.options()`` as follows:
</span><span class="s2">
</span><span class="s2">    .. code-block:: python
</span><span class="s2">
</span><span class="s2">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)
</span><span class="s2">        def f():
</span><span class="s2">            return 1, 2
</span><span class="s2">        g = f.options(num_gpus=2, max_calls=None)
</span><span class="s2">
</span><span class="s2">        @ray.remote(num_cpus=2, resources={&#34;CustomResource&#34;: 1})
</span><span class="s2">        class Foo:
</span><span class="s2">            def method(self):
</span><span class="s2">                return 1
</span><span class="s2">        Bar = Foo.options(num_cpus=1, resources=None)
</span><span class="s2">
</span><span class="s2">    Running remote actors will be terminated when the actor handle to them
</span><span class="s2">    in Python is deleted, which will cause them to complete any outstanding
</span><span class="s2">    work and then shut down. If you want to kill them immediately, you can
</span><span class="s2">    also call ``ray.kill(actor)``.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        num_returns (int): This is only for *remote functions*. It specifies
</span><span class="s2">            the number of object refs returned by
</span><span class="s2">            the remote function invocation.
</span><span class="s2">        num_cpus (float): The quantity of CPU cores to reserve
</span><span class="s2">            for this task or for the lifetime of the actor.
</span><span class="s2">        num_gpus (int): The quantity of GPUs to reserve
</span><span class="s2">            for this task or for the lifetime of the actor.
</span><span class="s2">        resources (Dict[str, float]): The quantity of various custom resources
</span><span class="s2">            to reserve for this task or for the lifetime of the actor.
</span><span class="s2">            This is a dictionary mapping strings (resource names) to floats.
</span><span class="s2">        accelerator_type: If specified, requires that the task or actor run
</span><span class="s2">            on a node with the specified type of accelerator.
</span><span class="s2">            See `ray.accelerators` for accelerator types.
</span><span class="s2">        max_calls (int): Only for *remote functions*. This specifies the
</span><span class="s2">            maximum number of times that a given worker can execute
</span><span class="s2">            the given remote function before it must exit
</span><span class="s2">            (this can be used to address memory leaks in third-party
</span><span class="s2">            libraries or to reclaim resources that cannot easily be
</span><span class="s2">            released, e.g., GPU memory that was acquired by TensorFlow).
</span><span class="s2">            By default this is infinite.
</span><span class="s2">        max_restarts (int): Only for *actors*. This specifies the maximum
</span><span class="s2">            number of times that the actor should be restarted when it dies
</span><span class="s2">            unexpectedly. The minimum valid value is 0 (default),
</span><span class="s2">            which indicates that the actor doesn&#39;t need to be restarted.
</span><span class="s2">            A value of -1 indicates that an actor should be restarted
</span><span class="s2">            indefinitely.
</span><span class="s2">        max_task_retries (int): Only for *actors*. How many times to
</span><span class="s2">            retry an actor task if the task fails due to a system error,
</span><span class="s2">            e.g., the actor has died. If set to -1, the system will
</span><span class="s2">            retry the failed task until the task succeeds, or the actor
</span><span class="s2">            has reached its max_restarts limit. If set to `n &gt; 0`, the
</span><span class="s2">            system will retry the failed task up to n times, after which the
</span><span class="s2">            task will throw a `RayActorError` exception upon :obj:`ray.get`.
</span><span class="s2">            Note that Python exceptions are not considered system errors
</span><span class="s2">            and will not trigger retries.
</span><span class="s2">        max_retries (int): Only for *remote functions*. This specifies
</span><span class="s2">            the maximum number of times that the remote function
</span><span class="s2">            should be rerun when the worker process executing it
</span><span class="s2">            crashes unexpectedly. The minimum valid value is 0,
</span><span class="s2">            the default is 4 (default), and a value of -1 indicates
</span><span class="s2">            infinite retries.
</span><span class="s2">        runtime_env (Dict[str, Any]): Specifies the runtime environment for
</span><span class="s2">            this actor or task and its children. See
</span><span class="s2">            :ref:`runtime-environments` for detailed documentation. This API is
</span><span class="s2">            in beta and may change before becoming stable.
</span><span class="s2">        retry_exceptions (bool): Only for *remote functions*. This specifies
</span><span class="s2">            whether application-level errors should be retried
</span><span class="s2">            up to max_retries times.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># This is the case where the decorator is just @ray.remote.</span>
        <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">)(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Parse the keyword arguments from the decorator.</span>
    <span class="n">valid_kwargs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&#34;num_returns&#34;</span><span class="p">,</span>
        <span class="s2">&#34;num_cpus&#34;</span><span class="p">,</span>
        <span class="s2">&#34;num_gpus&#34;</span><span class="p">,</span>
        <span class="s2">&#34;memory&#34;</span><span class="p">,</span>
        <span class="s2">&#34;object_store_memory&#34;</span><span class="p">,</span>
        <span class="s2">&#34;resources&#34;</span><span class="p">,</span>
        <span class="s2">&#34;accelerator_type&#34;</span><span class="p">,</span>
        <span class="s2">&#34;max_calls&#34;</span><span class="p">,</span>
        <span class="s2">&#34;max_restarts&#34;</span><span class="p">,</span>
        <span class="s2">&#34;max_task_retries&#34;</span><span class="p">,</span>
        <span class="s2">&#34;max_retries&#34;</span><span class="p">,</span>
        <span class="s2">&#34;runtime_env&#34;</span><span class="p">,</span>
        <span class="s2">&#34;retry_exceptions&#34;</span><span class="p">,</span>
        <span class="s2">&#34;placement_group&#34;</span><span class="p">,</span>
        <span class="s2">&#34;concurrency_groups&#34;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">error_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;The @ray.remote decorator must be applied either &#34;</span>
                    <span class="s2">&#34;with no arguments and no parentheses, for example &#34;</span>
                    <span class="s2">&#34;&#39;@ray.remote&#39;, or it must be applied using some of &#34;</span>
                    <span class="n">f</span><span class="s2">&#34;the arguments in the list {valid_kwargs}, for example &#34;</span>
                    <span class="s2">&#34;&#39;@ray.remote(num_returns=2, &#34;</span>
                    <span class="s2">&#34;resources={</span><span class="se">\&#34;</span><span class="s2">CustomResource</span><span class="se">\&#34;</span><span class="s2">: 1})&#39;.&#34;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error_string</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid_kwargs</span><span class="p">,</span> <span class="n">error_string</span>

    <span class="n">num_cpus</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;num_cpus&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&#34;num_cpus&#34;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">num_gpus</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;num_gpus&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&#34;num_gpus&#34;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;resources&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The &#39;resources&#39; keyword argument must be a &#34;</span>
                        <span class="n">f</span><span class="s2">&#34;dictionary, but received type {type(resources)}.&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&#34;CPU&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">,</span> <span class="s2">&#34;Use the &#39;num_cpus&#39; argument.&#34;</span>
        <span class="k">assert</span> <span class="s2">&#34;GPU&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">,</span> <span class="s2">&#34;Use the &#39;num_gpus&#39; argument.&#34;</span>

    <span class="n">accelerator_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;accelerator_type&#34;</span><span class="p">)</span>

    <span class="c1"># Handle other arguments.</span>
    <span class="n">num_returns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;num_returns&#34;</span><span class="p">)</span>
    <span class="n">max_calls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;max_calls&#34;</span><span class="p">)</span>
    <span class="n">max_restarts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;max_restarts&#34;</span><span class="p">)</span>
    <span class="n">max_task_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;max_task_retries&#34;</span><span class="p">)</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;memory&#34;</span><span class="p">)</span>
    <span class="n">object_store_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;object_store_memory&#34;</span><span class="p">)</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;max_retries&#34;</span><span class="p">)</span>
    <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;runtime_env&#34;</span><span class="p">)</span>
    <span class="n">placement_group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;placement_group&#34;</span><span class="p">,</span> <span class="s2">&#34;default&#34;</span><span class="p">)</span>
    <span class="n">retry_exceptions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;retry_exceptions&#34;</span><span class="p">)</span>
    <span class="n">concurrency_groups</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;concurrency_groups&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span>
        <span class="n">num_returns</span><span class="o">=</span><span class="n">num_returns</span><span class="p">,</span>
        <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
        <span class="n">num_gpus</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">,</span>
        <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
        <span class="n">object_store_memory</span><span class="o">=</span><span class="n">object_store_memory</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
        <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
        <span class="n">max_calls</span><span class="o">=</span><span class="n">max_calls</span><span class="p">,</span>
        <span class="n">max_restarts</span><span class="o">=</span><span class="n">max_restarts</span><span class="p">,</span>
        <span class="n">max_task_retries</span><span class="o">=</span><span class="n">max_task_retries</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
        <span class="n">runtime_env</span><span class="o">=</span><span class="n">runtime_env</span><span class="p">,</span>
        <span class="n">placement_group</span><span class="o">=</span><span class="n">placement_group</span><span class="p">,</span>
        <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
        <span class="n">retry_exceptions</span><span class="o">=</span><span class="n">retry_exceptions</span><span class="p">,</span>
        <span class="n">concurrency_groups</span><span class="o">=</span><span class="n">concurrency_groups</span> <span class="ow">or</span> <span class="p">[])</span>
</code></pre></td></tr></table></div>
</div>
</div><p>This function do nothing import, it just parse arguments and call function <code>make_decorator()</code>.</p>
<p><code>make_decorator()</code>.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">make_decorator</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">num_cpus</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">num_gpus</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">memory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">object_store_memory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">resources</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">accelerator_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">max_calls</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">max_retries</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">max_restarts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">max_task_retries</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">runtime_env</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">placement_group</span><span class="o">=</span><span class="s2">&#34;default&#34;</span><span class="p">,</span>
                   <span class="n">worker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">retry_exceptions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">concurrency_groups</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">is_cython</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">)):</span>
            <span class="c1"># Set the remote function default resources.</span>
            <span class="k">if</span> <span class="n">max_restarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;max_restarts&#39; is not &#34;</span>
                                 <span class="s2">&#34;allowed for remote functions.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_task_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;max_task_retries&#39; is not &#34;</span>
                                 <span class="s2">&#34;allowed for remote functions.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_returns</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                            <span class="ow">or</span> <span class="n">num_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&#34;The keyword &#39;num_returns&#39; only accepts 0 or a&#34;</span>
                    <span class="s2">&#34; positive integer&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_retries</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                            <span class="ow">or</span> <span class="n">max_retries</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&#34;The keyword &#39;max_retries&#39; only accepts 0, -1 or a&#34;</span>
                    <span class="s2">&#34; positive integer&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_calls</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                          <span class="ow">or</span> <span class="n">max_calls</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&#34;The keyword &#39;max_calls&#39; only accepts 0 or a positive&#34;</span>
                    <span class="s2">&#34; integer&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote_function</span><span class="o">.</span><span class="n">RemoteFunction</span><span class="p">(</span>
                <span class="n">Language</span><span class="o">.</span><span class="n">PYTHON</span><span class="p">,</span> <span class="n">function_or_class</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">,</span>
                <span class="n">memory</span><span class="p">,</span> <span class="n">object_store_memory</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">accelerator_type</span><span class="p">,</span>
                <span class="n">num_returns</span><span class="p">,</span> <span class="n">max_calls</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">,</span> <span class="n">retry_exceptions</span><span class="p">,</span>
                <span class="n">runtime_env</span><span class="p">,</span> <span class="n">placement_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num_returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;num_returns&#39; is not &#34;</span>
                                <span class="s2">&#34;allowed for actors.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;max_retries&#39; is not &#34;</span>
                                <span class="s2">&#34;allowed for actors.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retry_exceptions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;retry_exceptions&#39; is not &#34;</span>
                                <span class="s2">&#34;allowed for actors.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The keyword &#39;max_calls&#39; is not &#34;</span>
                                <span class="s2">&#34;allowed for actors.&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_restarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_restarts</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                             <span class="ow">or</span> <span class="n">max_restarts</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&#34;The keyword &#39;max_restarts&#39; only accepts -1, 0 or a&#34;</span>
                    <span class="s2">&#34; positive integer&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_task_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">max_task_retries</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_task_retries</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&#34;The keyword &#39;max_task_retries&#39; only accepts -1, 0 or a&#34;</span>
                    <span class="s2">&#34; positive integer&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">make_actor</span><span class="p">(</span>
                <span class="n">function_or_class</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span>
                <span class="n">object_store_memory</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">accelerator_type</span><span class="p">,</span> <span class="n">max_restarts</span><span class="p">,</span>
                <span class="n">max_task_retries</span><span class="p">,</span> <span class="n">runtime_env</span><span class="p">,</span> <span class="n">concurrency_groups</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;The @ray.remote decorator must be applied to &#34;</span>
                        <span class="s2">&#34;either a function or to a class.&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></td></tr></table></div>
</div>
</div><p>This function define a nested function <code>decorator()</code>. The <code>decorator()</code> function check parameter <code>function_or_class</code> is function or a class,</p>
<ul>
<li>if is function just call function <code>ray.remote_function.RemoteFunction()</code>.</li>
<li>if is class just call function <code>ray.actor.make_actor()</code></li>
</ul>
<p>The function <code>make_decorator()</code> just return nested function <code>decorator()</code></p>
<p><em>Q: where is the function_or_class come from?</em></p>
<p>In function nested function <code>decorator()</code>, add code  <code>print(&quot;Add by liudy&quot;, function_or_class)</code>.</p>
<ol>
<li>test code</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p>result:
<img src="/imgs/initiray.png" alt="">
just using <code>ray.init()</code> the function <code>decorator()</code> is called by 10 times</p>
<p><code>&lt;class 'ray.data.datasource.datasource._DesignatedBlockOwner'&gt;</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># locate python/ray/data/datasource/datasource.py</span>

<span class="nd">@ray.remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">placement_group</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_DesignatedBlockOwner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&#34;ok&#34;</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>&lt;function _hash at 0x7f3664d3c7b8&gt;</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># localte python/ray/workflow/common.py</span>
<span class="nd">@ray.remote</span>
<span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>&lt;function calculate_identifier at 0x7f3664d3cea0&gt;</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># localte python/ray/workflow/common.py</span>
<span class="nd">@ray.remote</span>
<span class="k">def</span> <span class="nf">calculate_identifier</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s2">&#34;&#34;&#34;Calculate a url-safe identifier for an object.&#34;&#34;&#34;</span>

    <span class="c1"># Step 1: Serialize the object.</span>
    <span class="c1"># Step 2: Calculate its sha256 hash.</span>
    <span class="c1"># Step 3: Get the url safe, base64 representation of it.</span>

    <span class="c1"># TODO (Alex): Ideally we should use the existing ObjectRef serializer to</span>
    <span class="c1"># avoid duplicate serialization passes and support nested object refs.</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>&lt;class 'ray.workflow.serialization.Manager'&gt;</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># locate: python/ray/workflow/serialization.py</span>
<span class="nd">@ray.remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Manager</span><span class="p">:</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    Responsible for deduping the serialization/upload of object references.
</span><span class="s2">    &#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="o">.</span><span class="n">Storage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploads</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">,</span> <span class="n">Upload</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_uploads</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Trivial function to ensure actor creation is successful.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">save_objectref</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ref_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">],</span>
            <span class="n">workflow_id</span><span class="p">:</span> <span class="s2">&#34;str&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]:</span>
        <span class="s2">&#34;&#34;&#34;Serialize and upload an object reference exactly once.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            ref_tuple: A 1-element tuple which wraps the reference.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            A pair. The first element is the paths the ref will be uploaded to.
</span><span class="s2">            The second is an object reference to the upload task.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">ref</span><span class="p">,</span> <span class="o">=</span> <span class="n">ref_tuple</span>
        <span class="c1"># Use the hex as the key to avoid holding a reference to the object.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="n">workflow_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploads</span><span class="p">:</span>
            <span class="c1"># TODO(Alex): We should probably eventually free these refs.</span>
            <span class="n">identifier_ref</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">calculate_identifier</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="n">upload_task</span> <span class="o">=</span> <span class="n">_put_helper</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">identifier_ref</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uploads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Upload</span><span class="p">(</span>
                <span class="n">identifier_ref</span><span class="o">=</span><span class="n">identifier_ref</span><span class="p">,</span> <span class="n">upload_task</span><span class="o">=</span><span class="n">upload_task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_uploads</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">identifer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">info</span><span class="o">.</span><span class="n">identifier_ref</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">obj_id_to_paths</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span> <span class="n">identifer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">upload_task</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">export_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;num_uploads&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_uploads</span><span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><ol start="2">
<li>test code</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="nd">@ray.remote</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<span class="n">futures</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

</code></pre></td></tr></table></div>
</div>
</div><p>result:
<img src="/imgs/rutstco.png" alt=""></p>
<h3 id="rayinit"><a href="#rayinit" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>@ray.init()</h3>
<p>locate worker.py</p>
<p>gcs_server 是一个编译好的程序，位于 /ray/python/ray/core/src/ray/gcs
通过使用 <code>subprocess.Popen</code> 来创建子进程</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">start_gcs_server</span><span class="p">(</span><span class="n">redis_address</span><span class="p">,</span>
                     <span class="n">log_dir</span><span class="p">,</span>
                     <span class="n">stdout_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">stderr_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">redis_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">fate_share</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">gcs_server_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">metrics_agent_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">node_ip_address</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Start a gcs server.
</span><span class="s2">    Args:
</span><span class="s2">        redis_address (str): The address that the Redis server is listening on.
</span><span class="s2">        log_dir (str): The path of the dir where log files are created.
</span><span class="s2">        stdout_file: A file handle opened for writing to redirect stdout to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        stderr_file: A file handle opened for writing to redirect stderr to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        redis_password (str): The password of the redis server.
</span><span class="s2">        config (dict|None): Optional configuration that will
</span><span class="s2">            override defaults in RayConfig.
</span><span class="s2">        gcs_server_port (int): Port number of the gcs server.
</span><span class="s2">        metrics_agent_port(int): The port where metrics agent is bound to.
</span><span class="s2">        node_ip_address(str): IP Address of a node where gcs server starts.
</span><span class="s2">    Returns:
</span><span class="s2">        ProcessInfo for the process that was started.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">gcs_ip_address</span><span class="p">,</span> <span class="n">gcs_port</span> <span class="o">=</span> <span class="n">redis_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
    <span class="n">redis_password</span> <span class="o">=</span> <span class="n">redis_password</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
    <span class="n">config_str</span> <span class="o">=</span> <span class="n">serialize_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gcs_server_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gcs_server_port</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">GCS_SERVER_EXECUTABLE</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis_address={gcs_ip_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis_port={gcs_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--log_dir={log_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--config_list={config_str}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--gcs_server_port={gcs_server_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--metrics-agent-port={metrics_agent_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--node-ip-address={node_ip_address}&#34;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&#34;--redis_password={redis_password}&#34;</span><span class="p">]</span>
    <span class="n">process_info</span> <span class="o">=</span> <span class="n">start_ray_process</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_GCS_SERVER</span><span class="p">,</span>
        <span class="n">stdout_file</span><span class="o">=</span><span class="n">stdout_file</span><span class="p">,</span>
        <span class="n">stderr_file</span><span class="o">=</span><span class="n">stderr_file</span><span class="p">,</span>
        <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_info</span>
</code></pre></td></tr></table></div>
</div>
</div><p>redis server 通过使用位于 /data/ray/ray/python/ray/core/src/ray/thirdparty/redis/src
的 redis-server 程序</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">start_redis</span><span class="p">(</span><span class="n">node_ip_address</span><span class="p">,</span>
                <span class="n">redirect_files</span><span class="p">,</span>
                <span class="n">resource_spec</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">redis_shard_ports</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">num_redis_shards</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">redis_max_clients</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">redirect_worker_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">fate_share</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">external_addresses</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">port_denylist</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Start the Redis global state store.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        node_ip_address: The IP address of the current node. This is only used
</span><span class="s2">            for recording the log filenames in Redis.
</span><span class="s2">        redirect_files: The list of (stdout, stderr) file pairs.
</span><span class="s2">        resource_spec (ResourceSpec): Resources for the node.
</span><span class="s2">        port (int): If provided, the primary Redis shard will be started on
</span><span class="s2">            this port.
</span><span class="s2">        redis_shard_ports: A list of the ports to use for the non-primary Redis
</span><span class="s2">            shards.
</span><span class="s2">        num_redis_shards (int): If provided, the number of Redis shards to
</span><span class="s2">            start, in addition to the primary one. The default value is one
</span><span class="s2">            shard.
</span><span class="s2">        redis_max_clients: If this is provided, Ray will attempt to configure
</span><span class="s2">            Redis with this maxclients number.
</span><span class="s2">        redirect_worker_output (bool): True if worker output should be
</span><span class="s2">            redirected to a file and false otherwise. Workers will have access
</span><span class="s2">            to this value when they start up.
</span><span class="s2">        password (str): Prevents external clients without the password
</span><span class="s2">            from connecting to Redis if provided.
</span><span class="s2">        port_denylist (set): A set of denylist ports that shouldn&#39;t
</span><span class="s2">            be used when allocating a new port.
</span><span class="s2">
</span><span class="s2">    Returns:
</span><span class="s2">        A tuple of the address for the primary Redis shard, a list of
</span><span class="s2">            addresses for the remaining shards, and the processes that were
</span><span class="s2">            started.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">external_addresses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">primary_redis_address</span> <span class="o">=</span> <span class="n">external_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">[</span><span class="n">primary_redis_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">primary_redis_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">redis_address</span> <span class="o">=</span> <span class="n">address</span><span class="p">(</span><span class="n">primary_redis_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">primary_redis_client</span> <span class="o">=</span> <span class="n">create_redis_client</span><span class="p">(</span>
            <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">primary_redis_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="c1"># Deleting the key to avoid duplicated rpush.</span>
        <span class="n">primary_redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;RedisShards&#34;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">redirect_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_redis_shards</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&#34;The number of redirect file pairs should be equal &#34;</span>
                <span class="s2">&#34;to the number of redis shards (including the &#34;</span>
                <span class="s2">&#34;primary shard) we will start.&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redis_shard_ports</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">redis_shard_ports</span> <span class="o">=</span> <span class="n">num_redis_shards</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">redis_shard_ports</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_redis_shards</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&#34;The number of Redis shard ports does not match &#34;</span>
                <span class="s2">&#34;the number of Redis shards.&#34;</span><span class="p">)</span>
        <span class="n">redis_executable</span> <span class="o">=</span> <span class="n">REDIS_EXECUTABLE</span>

        <span class="n">redis_stdout_file</span><span class="p">,</span> <span class="n">redis_stderr_file</span> <span class="o">=</span> <span class="n">redirect_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># If no port is given, fallback to default Redis port for the primary</span>
        <span class="c1"># shard.</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">DEFAULT_PORT</span>
            <span class="n">num_retries</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_retries</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Start the primary Redis shard.</span>
        <span class="n">port</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_start_redis_instance</span><span class="p">(</span>
            <span class="n">redis_executable</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
            <span class="n">redis_max_clients</span><span class="o">=</span><span class="n">redis_max_clients</span><span class="p">,</span>
            <span class="n">num_retries</span><span class="o">=</span><span class="n">num_retries</span><span class="p">,</span>
            <span class="c1"># Below we use None to indicate no limit on the memory of the</span>
            <span class="c1"># primary Redis shard.</span>
            <span class="n">redis_max_memory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">stdout_file</span><span class="o">=</span><span class="n">redis_stdout_file</span><span class="p">,</span>
            <span class="n">stderr_file</span><span class="o">=</span><span class="n">redis_stderr_file</span><span class="p">,</span>
            <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">,</span>
            <span class="n">port_denylist</span><span class="o">=</span><span class="n">port_denylist</span><span class="p">,</span>
            <span class="n">listen_to_localhost_only</span><span class="o">=</span><span class="p">(</span><span class="n">node_ip_address</span> <span class="o">==</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">))</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">redis_address</span> <span class="o">=</span> <span class="n">address</span><span class="p">(</span><span class="n">node_ip_address</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">primary_redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">node_ip_address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># Register the number of Redis shards in the primary shard, so that clients</span>
    <span class="c1"># know how many redis shards to expect under RedisShards.</span>
    <span class="n">primary_redis_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;NumRedisShards&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_redis_shards</span><span class="p">))</span>

    <span class="c1"># Put the redirect_worker_output bool in the Redis shard so that workers</span>
    <span class="c1"># can access it and know whether or not to redirect their output.</span>
    <span class="n">primary_redis_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;RedirectOutput&#34;</span><span class="p">,</span> <span class="mi">1</span>
                             <span class="k">if</span> <span class="n">redirect_worker_output</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Init job counter to GCS.</span>
    <span class="n">primary_redis_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;JobCounter&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Store version information in the primary Redis shard.</span>
    <span class="n">_put_version_info_in_redis</span><span class="p">(</span><span class="n">primary_redis_client</span><span class="p">)</span>

    <span class="c1"># Calculate the redis memory.</span>
    <span class="k">assert</span> <span class="n">resource_spec</span><span class="o">.</span><span class="n">resolved</span><span class="p">()</span>
    <span class="n">redis_max_memory</span> <span class="o">=</span> <span class="n">resource_spec</span><span class="o">.</span><span class="n">redis_max_memory</span>

    <span class="c1"># Start other Redis shards. Each Redis shard logs to a separate file,</span>
    <span class="c1"># prefixed by &#34;redis-&lt;shard number&gt;&#34;.</span>
    <span class="n">redis_shards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># If Redis shard ports are not provided, start the port range of the</span>
    <span class="c1"># other Redis shards at a high, random port.</span>
    <span class="n">last_shard_port</span> <span class="o">=</span> <span class="n">new_port</span><span class="p">(</span><span class="n">denylist</span><span class="o">=</span><span class="n">port_denylist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_redis_shards</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">external_addresses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">shard_address</span> <span class="o">=</span> <span class="n">external_addresses</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redis_stdout_file</span><span class="p">,</span> <span class="n">redis_stderr_file</span> <span class="o">=</span> <span class="n">redirect_files</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">redis_executable</span> <span class="o">=</span> <span class="n">REDIS_EXECUTABLE</span>
            <span class="n">redis_shard_port</span> <span class="o">=</span> <span class="n">redis_shard_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># If no shard port is given, try to start this shard&#39;s Redis</span>
            <span class="c1"># instance on the port right after the last shard&#39;s port.</span>
            <span class="k">if</span> <span class="n">redis_shard_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">redis_shard_port</span> <span class="o">=</span> <span class="n">last_shard_port</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">num_retries</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_retries</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">redis_shard_port</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_start_redis_instance</span><span class="p">(</span>
                <span class="n">redis_executable</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="n">redis_shard_port</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                <span class="n">redis_max_clients</span><span class="o">=</span><span class="n">redis_max_clients</span><span class="p">,</span>
                <span class="n">num_retries</span><span class="o">=</span><span class="n">num_retries</span><span class="p">,</span>
                <span class="n">redis_max_memory</span><span class="o">=</span><span class="n">redis_max_memory</span><span class="p">,</span>
                <span class="n">stdout_file</span><span class="o">=</span><span class="n">redis_stdout_file</span><span class="p">,</span>
                <span class="n">stderr_file</span><span class="o">=</span><span class="n">redis_stderr_file</span><span class="p">,</span>
                <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">,</span>
                <span class="n">port_denylist</span><span class="o">=</span><span class="n">port_denylist</span><span class="p">,</span>
                <span class="n">listen_to_localhost_only</span><span class="o">=</span><span class="p">(</span><span class="n">node_ip_address</span> <span class="o">==</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">))</span>
            <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">shard_address</span> <span class="o">=</span> <span class="n">address</span><span class="p">(</span><span class="n">node_ip_address</span><span class="p">,</span> <span class="n">redis_shard_port</span><span class="p">)</span>
            <span class="n">last_shard_port</span> <span class="o">=</span> <span class="n">redis_shard_port</span>

        <span class="n">redis_shards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shard_address</span><span class="p">)</span>
        <span class="c1"># Store redis shard information in the primary redis shard.</span>
        <span class="n">primary_redis_client</span><span class="o">.</span><span class="n">rpush</span><span class="p">(</span><span class="s2">&#34;RedisShards&#34;</span><span class="p">,</span> <span class="n">shard_address</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redis_address</span><span class="p">,</span> <span class="n">redis_shards</span><span class="p">,</span> <span class="n">processes</span>
</code></pre></td></tr></table></div>
</div>
</div><p>start monitor 通过 cmd 调用 python monitor.py 执行</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">start_monitor</span><span class="p">(</span><span class="n">redis_address</span><span class="p">,</span>
                  <span class="n">logs_dir</span><span class="p">,</span>
                  <span class="n">stdout_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">stderr_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">autoscaling_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">redis_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">fate_share</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">max_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">backup_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">monitor_ip</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Run a process to monitor the other processes.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        redis_address (str): The address that the Redis server is listening on.
</span><span class="s2">        logs_dir(str): The path to the log directory.
</span><span class="s2">        stdout_file: A file handle opened for writing to redirect stdout to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        stderr_file: A file handle opened for writing to redirect stderr to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        autoscaling_config: path to autoscaling config file.
</span><span class="s2">        redis_password (str): The password of the redis server.
</span><span class="s2">        max_bytes (int): Log rotation parameter. Corresponding to
</span><span class="s2">            RotatingFileHandler&#39;s maxBytes.
</span><span class="s2">        backup_count (int): Log rotation parameter. Corresponding to
</span><span class="s2">            RotatingFileHandler&#39;s backupCount.
</span><span class="s2">        monitor_ip (str): IP address of the machine that the monitor will be
</span><span class="s2">            run on. Can be excluded, but required for autoscaler metrics.
</span><span class="s2">    Returns:
</span><span class="s2">        ProcessInfo for the process that was started.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">monitor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RAY_PATH</span><span class="p">,</span> <span class="n">AUTOSCALER_PRIVATE_DIR</span><span class="p">,</span> <span class="s2">&#34;monitor.py&#34;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&#34;-u&#34;</span><span class="p">,</span> <span class="n">monitor_path</span><span class="p">,</span> <span class="n">f</span><span class="s2">&#34;--logs-dir={logs_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis-address={redis_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--logging-rotate-bytes={max_bytes}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--logging-rotate-backup-count={backup_count}&#34;</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">autoscaling_config</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--autoscaling-config=&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">autoscaling_config</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--redis-password=&#34;</span> <span class="o">+</span> <span class="n">redis_password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">monitor_ip</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--monitor-ip=&#34;</span> <span class="o">+</span> <span class="n">monitor_ip</span><span class="p">)</span>
    <span class="n">process_info</span> <span class="o">=</span> <span class="n">start_ray_process</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_MONITOR</span><span class="p">,</span>
        <span class="n">stdout_file</span><span class="o">=</span><span class="n">stdout_file</span><span class="p">,</span>
        <span class="n">stderr_file</span><span class="o">=</span><span class="n">stderr_file</span><span class="p">,</span>
        <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_info</span>
</code></pre></td></tr></table></div>
</div>
</div><p>start ray client server 通过 cmd 调用 python</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ef</span> <span class="n">start_ray_client_server</span><span class="p">(</span>
        <span class="n">redis_address</span><span class="p">,</span>
        <span class="n">ray_client_server_port</span><span class="p">,</span>
        <span class="n">stdout_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">stderr_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">redis_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">fate_share</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">metrics_agent_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">server_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;proxy&#34;</span><span class="p">,</span>
        <span class="n">serialized_runtime_env_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Run the server process of the Ray client.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        ray_client_server_port (int): Port the Ray client server listens on.
</span><span class="s2">        stdout_file: A file handle opened for writing to redirect stdout to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        stderr_file: A file handle opened for writing to redirect stderr to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        redis_password (str): The password of the redis server.
</span><span class="s2">        server_type (str): Whether to start the proxy version of Ray Client.
</span><span class="s2">        serialized_runtime_env_context (str|None): If specified, the serialized
</span><span class="s2">            runtime_env_context to start the client server in.
</span><span class="s2">
</span><span class="s2">    Returns:
</span><span class="s2">        ProcessInfo for the process that was started.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">root_ray_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">setup_worker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_ray_dir</span><span class="p">,</span> <span class="s2">&#34;workers&#34;</span><span class="p">,</span>
                                     <span class="n">ray_constants</span><span class="o">.</span><span class="n">SETUP_WORKER_FILENAME</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="n">setup_worker_path</span><span class="p">,</span>
        <span class="s2">&#34;-m&#34;</span><span class="p">,</span>
        <span class="s2">&#34;ray.util.client.server&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis-address={redis_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--port={ray_client_server_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--mode={server_type}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--language={Language.Name(Language.PYTHON)}&#34;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;--redis-password={redis_password}&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serialized_runtime_env_context</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&#34;--serialized-runtime-env-context={serialized_runtime_env_context}&#34;</span>  <span class="c1"># noqa: E501</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">metrics_agent_port</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;--metrics-agent-port={metrics_agent_port}&#34;</span><span class="p">)</span>
    <span class="n">process_info</span> <span class="o">=</span> <span class="n">start_ray_process</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_RAY_CLIENT_SERVER</span><span class="p">,</span>
        <span class="n">stdout_file</span><span class="o">=</span><span class="n">stdout_file</span><span class="p">,</span>
        <span class="n">stderr_file</span><span class="o">=</span><span class="n">stderr_file</span><span class="p">,</span>
        <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_info</span>
</code></pre></td></tr></table></div>
</div>
</div><p>start redis client 位于 /data/ray/ray/python/ray/core/src/ray/thirdparty/redis/src/ 下的程序 redis-cli</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">create_redis_client</span><span class="p">(</span><span class="n">redis_address</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Create a Redis client.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        The IP address, port, and password of the Redis server.
</span><span class="s2">
</span><span class="s2">    Returns:
</span><span class="s2">        A Redis client.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">create_redis_client</span><span class="p">,</span> <span class="s2">&#34;instances&#34;</span><span class="p">):</span>
        <span class="n">create_redis_client</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">create_redis_client</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cli</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">cli</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">create_redis_client</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">redis_address</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">redis_ip_address</span><span class="p">,</span> <span class="n">redis_port</span> <span class="o">=</span> <span class="n">validate_redis_address</span><span class="p">(</span><span class="n">redis_address</span><span class="p">)</span>
    <span class="c1"># For this command to work, some other client (on the same machine</span>
    <span class="c1"># as Redis) must have run &#34;CONFIG SET protected-mode no&#34;.</span>
    <span class="n">create_redis_client</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">redis_address</span><span class="p">]</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="n">redis_ip_address</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">create_redis_client</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">redis_address</span><span class="p">]</span>

</code></pre></td></tr></table></div>
</div>
</div><p>start raylet (combined local scheduler and object manager.), 运行位于 ray/python/ray/core/src/ray/raylet/
的 raylet 程序, 调用 raylet 程序的终端命令为：</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"> <span class="o">[</span><span class="s1">&#39;/data/ray/ray/python/ray/core/src/ray/raylet/raylet&#39;</span>, <span class="s1">&#39;--raylet_socket_name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/raylet&#39;</span>, <span class="s1">&#39;--store_socket_name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/plasma_store&#39;</span>, <span class="s1">&#39;--object_manager_port=0&#39;</span>, <span class="s1">&#39;--min_worker_port=0&#39;</span>, <span class="s1">&#39;--max_worker_port=0&#39;</span>, <span class="s1">&#39;--node_manager_port=0&#39;</span>, <span class="s1">&#39;--node_ip_address=10.186.115.19&#39;</span>, <span class="s1">&#39;--redis_address=10.186.115.19&#39;</span>, <span class="s1">&#39;--redis_port=6379&#39;</span>, <span class="s1">&#39;--maximum_startup_concurrency=10&#39;</span>, <span class="s1">&#39;--static_resource_list=node:10.186.115.19,1.0,CPU,10,memory,54792238695,object_store_memory,27396119347&#39;</span>, <span class="s1">&#39;--python_worker_command=/usr/bin/python /data/ray/ray/python/ray/workers/setup_worker.py /data/ray/ray/python/ray/workers/default_worker.py --node-ip-address=10.186.115.19 --node-manager-port=RAY_NODE_MANAGER_PORT_PLACEHOLDER --object-store-name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/plasma_store --raylet-name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/raylet --redis-address=10.186.115.19:6379 --temp-dir=/tmp/ray --metrics-agent-port=41628 --logging-rotate-bytes=536870912 --logging-rotate-backup-count=5 RAY_WORKER_DYNAMIC_OPTION_PLACEHOLDER --redis-password=5241590000000000&#39;</span>, <span class="s1">&#39;--java_worker_command=&#39;</span>, <span class="s1">&#39;--cpp_worker_command=/data/ray/ray/python/ray/cpp/default_worker --ray_plasma_store_socket_name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/plasma_store --ray_raylet_socket_name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/raylet --ray_node_manager_port=RAY_NODE_MANAGER_PORT_PLACEHOLDER --ray_address=10.186.115.19:6379 --ray_redis_password=5241590000000000 --ray_session_dir=/tmp/ray/session_2021-12-07_14-51-20_860909_63031 --ray_logs_dir=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/logs --ray_node_ip_address=10.186.115.19 RAY_WORKER_DYNAMIC_OPTION_PLACEHOLDER&#39;</span>, <span class="s1">&#39;--native_library_path=/data/ray/ray/python/ray/cpp/lib&#39;</span>, <span class="s1">&#39;--redis_password=5241590000000000&#39;</span>, <span class="s1">&#39;--temp_dir=/tmp/ray&#39;</span>, <span class="s1">&#39;--session_dir=/tmp/ray/session_2021-12-07_14-51-20_860909_63031&#39;</span>, <span class="s1">&#39;--log_dir=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/logs&#39;</span>, <span class="s1">&#39;--resource_dir=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/runtime_resources&#39;</span>, <span class="s1">&#39;--metrics-agent-port=41628&#39;</span>, <span class="s1">&#39;--metrics_export_port=53756&#39;</span>, <span class="s1">&#39;--object_store_memory=27396119347&#39;</span>, <span class="s1">&#39;--plasma_directory=/dev/shm&#39;</span>, <span class="s1">&#39;--ray-debugger-external=0&#39;</span>, <span class="s1">&#39;--num_initial_python_workers_for_first_job=10&#39;</span>, <span class="s1">&#39;--agent_command=&#39;</span>
</code></pre></td></tr></table></div>
</div>
</div><p>其中开启多个 worker 进程的命令为, 开启多少个 worker 设置为 <code>--maximum_startup_concurrency=10</code></p>
<pre><code>--python_worker_command=/usr/bin/python /data/ray/ray/python/ray/workers/setup_worker.py /data/ray/ray/python/ray/workers/default_worker.py --node-ip-address=10.186.115.19 --node-manager-port=RAY_NODE_MANAGER_PORT_PLACEHOLDER --object-store-name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/plasma_store --raylet-name=/tmp/ray/session_2021-12-07_14-51-20_860909_63031/sockets/raylet --redis-address=10.186.115.19:6379 --temp-dir=/tmp/ray --metrics-agent-port=41628 --logging-rotate-bytes=536870912 --logging-rotate-backup-count=5 RAY_WORKER_DYNAMIC_OPTION_PLACEHOLDER --redis-password=5241590000000000',
</code></pre><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ef</span> <span class="n">start_raylet</span><span class="p">(</span><span class="n">redis_address</span><span class="p">,</span>
                 <span class="n">node_ip_address</span><span class="p">,</span>
                 <span class="n">node_manager_port</span><span class="p">,</span>
                 <span class="n">raylet_name</span><span class="p">,</span>
                 <span class="n">plasma_store_name</span><span class="p">,</span>
                 <span class="n">worker_path</span><span class="p">,</span>
                 <span class="n">setup_worker_path</span><span class="p">,</span>
                 <span class="n">temp_dir</span><span class="p">,</span>
                 <span class="n">session_dir</span><span class="p">,</span>
                 <span class="n">resource_dir</span><span class="p">,</span>
                 <span class="n">log_dir</span><span class="p">,</span>
                 <span class="n">resource_spec</span><span class="p">,</span>
                 <span class="n">plasma_directory</span><span class="p">,</span>
                 <span class="n">object_store_memory</span><span class="p">,</span>
                 <span class="n">min_worker_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_worker_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">worker_port_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">object_manager_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">redis_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">metrics_agent_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">metrics_export_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dashboard_agent_listen_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">use_valgrind</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">use_profiler</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">stdout_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">stderr_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">huge_pages</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">fate_share</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">socket_to_use</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">start_initial_python_workers_for_first_job</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">max_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">backup_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ray_debugger_external</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">env_updates</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Start a raylet, which is a combined local scheduler and object manager.
</span><span class="s2">
</span><span class="s2">    Args:
</span><span class="s2">        redis_address (str): The address of the primary Redis server.
</span><span class="s2">        node_ip_address (str): The IP address of this node.
</span><span class="s2">        node_manager_port(int): The port to use for the node manager. If it&#39;s
</span><span class="s2">            0, a random port will be used.
</span><span class="s2">        raylet_name (str): The name of the raylet socket to create.
</span><span class="s2">        plasma_store_name (str): The name of the plasma store socket to connect
</span><span class="s2">             to.
</span><span class="s2">        worker_path (str): The path of the Python file that new worker
</span><span class="s2">            processes will execute.
</span><span class="s2">        setup_worker_path (str): The path of the Python file that will set up
</span><span class="s2">            the environment for the worker process.
</span><span class="s2">        temp_dir (str): The path of the temporary directory Ray will use.
</span><span class="s2">        session_dir (str): The path of this session.
</span><span class="s2">        resource_dir(str): The path of resource of this session .
</span><span class="s2">        log_dir (str): The path of the dir where log files are created.
</span><span class="s2">        resource_spec (ResourceSpec): Resources for this raylet.
</span><span class="s2">        object_manager_port: The port to use for the object manager. If this is
</span><span class="s2">            None, then the object manager will choose its own port.
</span><span class="s2">        min_worker_port (int): The lowest port number that workers will bind
</span><span class="s2">            on. If not set, random ports will be chosen.
</span><span class="s2">        max_worker_port (int): The highest port number that workers will bind
</span><span class="s2">            on. If set, min_worker_port must also be set.
</span><span class="s2">        redis_password: The password to use when connecting to Redis.
</span><span class="s2">        metrics_agent_port(int): The port where metrics agent is bound to.
</span><span class="s2">        metrics_export_port(int): The port at which metrics are exposed to.
</span><span class="s2">        use_valgrind (bool): True if the raylet should be started inside
</span><span class="s2">            of valgrind. If this is True, use_profiler must be False.
</span><span class="s2">        use_profiler (bool): True if the raylet should be started inside
</span><span class="s2">            a profiler. If this is True, use_valgrind must be False.
</span><span class="s2">        stdout_file: A file handle opened for writing to redirect stdout to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        stderr_file: A file handle opened for writing to redirect stderr to. If
</span><span class="s2">            no redirection should happen, then this should be None.
</span><span class="s2">        tracing_startup_hook: Tracing startup hook.
</span><span class="s2">        config (dict|None): Optional Raylet configuration that will
</span><span class="s2">            override defaults in RayConfig.
</span><span class="s2">        max_bytes (int): Log rotation parameter. Corresponding to
</span><span class="s2">            RotatingFileHandler&#39;s maxBytes.
</span><span class="s2">        backup_count (int): Log rotation parameter. Corresponding to
</span><span class="s2">            RotatingFileHandler&#39;s backupCount.
</span><span class="s2">        ray_debugger_external (bool): True if the Ray debugger should be made
</span><span class="s2">            available externally to this node.
</span><span class="s2">        env_updates (dict): Environment variable overrides.
</span><span class="s2">
</span><span class="s2">    Returns:
</span><span class="s2">        ProcessInfo for the process that was started.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">assert</span> <span class="n">node_manager_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">node_manager_port</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>

    <span class="k">if</span> <span class="n">use_valgrind</span> <span class="ow">and</span> <span class="n">use_profiler</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Cannot use valgrind and profiler at the same time.&#34;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">resource_spec</span><span class="o">.</span><span class="n">resolved</span><span class="p">()</span>
    <span class="n">static_resources</span> <span class="o">=</span> <span class="n">resource_spec</span><span class="o">.</span><span class="n">to_resource_dict</span><span class="p">()</span>

    <span class="c1"># Limit the number of workers that can be started in parallel by the</span>
    <span class="c1"># raylet. However, make sure it is at least 1.</span>
    <span class="n">num_cpus_static</span> <span class="o">=</span> <span class="n">static_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;CPU&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">maximum_startup_concurrency</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">num_cpus_static</span><span class="p">))</span>

    <span class="c1"># Format the resource argument in a form like &#39;CPU,1.0,GPU,0,Custom,3&#39;.</span>
    <span class="n">resource_argument</span> <span class="o">=</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&#34;{},{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">kv</span><span class="p">)</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">static_resources</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">gcs_ip_address</span><span class="p">,</span> <span class="n">gcs_port</span> <span class="o">=</span> <span class="n">redis_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>

    <span class="n">has_java_command</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&#34;java&#34;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">has_java_command</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">ray_java_installed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jars_dir</span> <span class="o">=</span> <span class="n">get_ray_jars_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jars_dir</span><span class="p">):</span>
            <span class="n">ray_java_installed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">include_java</span> <span class="o">=</span> <span class="n">has_java_command</span> <span class="ow">and</span> <span class="n">ray_java_installed</span>
    <span class="k">if</span> <span class="n">include_java</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">java_worker_command</span> <span class="o">=</span> <span class="n">build_java_worker_command</span><span class="p">(</span>
            <span class="n">redis_address</span><span class="p">,</span>
            <span class="n">plasma_store_name</span><span class="p">,</span>
            <span class="n">raylet_name</span><span class="p">,</span>
            <span class="n">redis_password</span><span class="p">,</span>
            <span class="n">session_dir</span><span class="p">,</span>
            <span class="n">node_ip_address</span><span class="p">,</span>
            <span class="n">setup_worker_path</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">java_worker_command</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DEFAULT_WORKER_EXECUTABLE</span><span class="p">):</span>
        <span class="n">cpp_worker_command</span> <span class="o">=</span> <span class="n">build_cpp_worker_command</span><span class="p">(</span>
            <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">redis_address</span><span class="p">,</span> <span class="n">plasma_store_name</span><span class="p">,</span> <span class="n">raylet_name</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span>
            <span class="n">session_dir</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">,</span> <span class="n">node_ip_address</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cpp_worker_command</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create the command that the Raylet will use to start workers.</span>
    <span class="c1"># TODO(architkulkarni): Pipe in setup worker args separately instead of</span>
    <span class="c1"># inserting them into start_worker_command and later erasing them if</span>
    <span class="c1"># needed.</span>
    <span class="n">start_worker_command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="n">setup_worker_path</span><span class="p">,</span>
        <span class="n">worker_path</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--node-ip-address={node_ip_address}&#34;</span><span class="p">,</span>
        <span class="s2">&#34;--node-manager-port=RAY_NODE_MANAGER_PORT_PLACEHOLDER&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--object-store-name={plasma_store_name}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--raylet-name={raylet_name}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis-address={redis_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--temp-dir={temp_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--metrics-agent-port={metrics_agent_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--logging-rotate-bytes={max_bytes}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--logging-rotate-backup-count={backup_count}&#34;</span><span class="p">,</span>
        <span class="s2">&#34;RAY_WORKER_DYNAMIC_OPTION_PLACEHOLDER&#34;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
        <span class="n">start_worker_command</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&#34;--redis-password={redis_password}&#34;</span><span class="p">]</span>

    <span class="c1"># If the object manager port is None, then use 0 to cause the object</span>
    <span class="c1"># manager to choose its own port.</span>
    <span class="k">if</span> <span class="n">object_manager_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">object_manager_port</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">min_worker_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">min_worker_port</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">max_worker_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">max_worker_port</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">check_dashboard_dependencies_installed</span><span class="p">():</span>
        <span class="c1"># An empty agent command will cause the raylet not to start it.</span>
        <span class="n">agent_command</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">agent_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
            <span class="s2">&#34;-u&#34;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RAY_PATH</span><span class="p">,</span> <span class="s2">&#34;dashboard&#34;</span><span class="p">,</span> <span class="s2">&#34;agent.py&#34;</span><span class="p">),</span>
            <span class="n">f</span><span class="s2">&#34;--node-ip-address={node_ip_address}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--redis-address={redis_address}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--metrics-export-port={metrics_export_port}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--dashboard-agent-port={metrics_agent_port}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--listen-port={dashboard_agent_listen_port}&#34;</span><span class="p">,</span>
            <span class="s2">&#34;--node-manager-port=RAY_NODE_MANAGER_PORT_PLACEHOLDER&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--object-store-name={plasma_store_name}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--raylet-name={raylet_name}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--temp-dir={temp_dir}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--session-dir={session_dir}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--runtime-env-dir={resource_dir}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--log-dir={log_dir}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--logging-rotate-bytes={max_bytes}&#34;</span><span class="p">,</span>
            <span class="n">f</span><span class="s2">&#34;--logging-rotate-backup-count={backup_count}&#34;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">redis_password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">redis_password</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">agent_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--redis-password={}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">RAYLET_EXECUTABLE</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--raylet_socket_name={raylet_name}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--store_socket_name={plasma_store_name}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--object_manager_port={object_manager_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--min_worker_port={min_worker_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--max_worker_port={max_worker_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--node_manager_port={node_manager_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--node_ip_address={node_ip_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis_address={gcs_ip_address}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis_port={gcs_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--maximum_startup_concurrency={maximum_startup_concurrency}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--static_resource_list={resource_argument}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--python_worker_command={subprocess.list2cmdline(start_worker_command)}&#34;</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">f</span><span class="s2">&#34;--java_worker_command={subprocess.list2cmdline(java_worker_command)}&#34;</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">f</span><span class="s2">&#34;--cpp_worker_command={subprocess.list2cmdline(cpp_worker_command)}&#34;</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">f</span><span class="s2">&#34;--native_library_path={DEFAULT_NATIVE_LIBRARY_PATH}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--redis_password={redis_password or &#39;&#39;}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--temp_dir={temp_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--session_dir={session_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--log_dir={log_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--resource_dir={resource_dir}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--metrics-agent-port={metrics_agent_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--metrics_export_port={metrics_export_port}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--object_store_memory={object_store_memory}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--plasma_directory={plasma_directory}&#34;</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&#34;--ray-debugger-external={1 if ray_debugger_external else 0}&#34;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">worker_port_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;--worker_port_list={worker_port_list}&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_initial_python_workers_for_first_job</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--num_initial_python_workers_for_first_job={}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">resource_spec</span><span class="o">.</span><span class="n">num_cpus</span><span class="p">))</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--agent_command={}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">agent_command</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">huge_pages</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;--huge_pages&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">socket_to_use</span><span class="p">:</span>
        <span class="n">socket_to_use</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">process_info</span> <span class="o">=</span> <span class="n">start_ray_process</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_RAYLET</span><span class="p">,</span>
        <span class="n">use_valgrind</span><span class="o">=</span><span class="n">use_valgrind</span><span class="p">,</span>
        <span class="n">use_gdb</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">use_valgrind_profiler</span><span class="o">=</span><span class="n">use_profiler</span><span class="p">,</span>
        <span class="n">use_perftools_profiler</span><span class="o">=</span><span class="p">(</span><span class="s2">&#34;RAYLET_PERFTOOLS_PATH&#34;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">),</span>
        <span class="n">stdout_file</span><span class="o">=</span><span class="n">stdout_file</span><span class="p">,</span>
        <span class="n">stderr_file</span><span class="o">=</span><span class="n">stderr_file</span><span class="p">,</span>
        <span class="n">fate_share</span><span class="o">=</span><span class="n">fate_share</span><span class="p">,</span>
        <span class="n">env_updates</span><span class="o">=</span><span class="n">env_updates</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">process_info</span>
</code></pre></td></tr></table></div>
</div>
</div><p>start head processes (node.py)</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">start_head_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Start head processes on the node.&#34;&#34;&#34;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Process STDOUT and STDERR is being &#34;</span>
                  <span class="n">f</span><span class="s2">&#34;redirected to {self._logs_dir}.&#34;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_address</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="c1"># If this is the head node, start the relevant head node processes.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_redis</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">start_gcs_server</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">no_monitor</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_monitor</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">ray_client_server_port</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ray_client_server</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">include_dashboard</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_dashboard</span><span class="p">(</span><span class="n">require_dashboard</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">include_dashboard</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_dashboard</span><span class="p">(</span><span class="n">require_dashboard</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><p>start redis_servers (node.py)</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">start_redis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Start the Redis servers.&#34;&#34;&#34;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_address</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="n">redis_log_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">external_addresses</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">redis_log_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_log_file_handles</span><span class="p">(</span><span class="s2">&#34;redis&#34;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">num_redis_shards</span><span class="p">):</span>
            <span class="n">redis_log_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_log_file_handles</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;redis-shard_{i}&#34;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_redis_address</span><span class="p">,</span> <span class="n">redis_shards</span><span class="p">,</span>
      <span class="n">process_infos</span><span class="p">)</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">start_redis</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_node_ip_address</span><span class="p">,</span>
          <span class="n">redis_log_files</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_spec</span><span class="p">(),</span>
          <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">redis_port</span><span class="p">,</span>
          <span class="n">redis_shard_ports</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">redis_shard_ports</span><span class="p">,</span>
          <span class="n">num_redis_shards</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">num_redis_shards</span><span class="p">,</span>
          <span class="n">redis_max_clients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">redis_max_clients</span><span class="p">,</span>
          <span class="n">redirect_worker_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
          <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">redis_password</span><span class="p">,</span>
          <span class="n">fate_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_fate_share</span><span class="p">,</span>
          <span class="n">external_addresses</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">external_addresses</span><span class="p">,</span>
          <span class="n">port_denylist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ray_params</span><span class="o">.</span><span class="n">reserved_ports</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_REDIS_SERVER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_processes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_processes</span><span class="p">[</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">PROCESS_TYPE_REDIS_SERVER</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">process_infos</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><h3 id="core_workerh"><a href="#core_workerh" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>core_worker.h</h3>
<p>class CoreWorker, 在构造函数中</p>
<ol>
<li>初始化 task receivers， raylet client,</li>
<li>start a rpc server</li>
<li>Initialize gcs client</li>
<li>Initialize profiler</li>
<li>Start IO thread</li>
</ol>
<h3 id="taskspecification-class"><a href="#taskspecification-class" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>TaskSpecification class</h3>
<p>location: <code>task_spec.h</code></p>
<h3 id="functiondescriptorinterface-class"><a href="#functiondescriptorinterface-class" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>FunctionDescriptorInterface class</h3>
<ul>
<li>function_descriptor.h</li>
</ul>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp">  <span class="k">class</span> <span class="nc">FunctionDescriptorInterface</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MessageWrapper</span><span class="o">&lt;</span><span class="n">rpc</span><span class="o">::</span><span class="n">FunctionDescriptor</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">FunctionDescriptorInterface</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">/// Construct an empty FunctionDescriptor.
</span><span class="c1"></span>  <span class="n">FunctionDescriptorInterface</span><span class="p">()</span> <span class="o">:</span> <span class="n">MessageWrapper</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">/// Construct from a protobuf message object.
</span><span class="c1"></span>  <span class="c1">/// The input message will be **copied** into this object.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// \param message The protobuf message.
</span><span class="c1"></span>  <span class="n">FunctionDescriptorInterface</span><span class="p">(</span><span class="n">rpc</span><span class="o">::</span><span class="n">FunctionDescriptor</span> <span class="n">message</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">MessageWrapper</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">{}</span>

  <span class="n">ray</span><span class="o">::</span><span class="n">FunctionDescriptorType</span> <span class="n">Type</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">message_</span><span class="o">-&gt;</span><span class="n">function_descriptor_case</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">size_t</span> <span class="nf">Hash</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// DO NOT define operator==() or operator!=() in the base class.
</span><span class="c1"></span>  <span class="c1">// Let the derived classes define and implement.
</span><span class="c1"></span>  <span class="c1">// This is to avoid unexpected behaviors when comparing function descriptors of
</span><span class="c1"></span>  <span class="c1">// different declard types, as in this case, the base class version is invoked.
</span><span class="c1"></span>
  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ToString</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// A one-word summary of the function call site (e.g., __main__.foo).
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CallSiteString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">CallString</span><span class="p">();</span> <span class="p">}</span>

  <span class="c1">// The function or method call, e.g. &#34;foo()&#34; or &#34;Bar.foo()&#34;. This does not include the
</span><span class="c1"></span>  <span class="c1">// module/library.
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CallString</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// The default name for a task that executes this function.
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DefaultTaskName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">CallString</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;()&#34;</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Subtype</span><span class="o">&gt;</span>
  <span class="n">Subtype</span> <span class="o">*</span><span class="n">As</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Subtype</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

</code></pre></td></tr></table></div>
</div>
</div><p>PythonFunctionDescriptor class, 通过 RPC 接收来的 <code>rpc::FunctionDescriptor messag</code> 包含了四个信息: module_name, class_name, function_name, function_hash</p>
<pre><code>message PythonFunctionDescriptor {
  string module_name = 1;
  string class_name = 2;
  string function_name = 3;
  string function_hash = 4;
}
</code></pre><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">PythonFunctionDescriptor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">FunctionDescriptorInterface</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">/// Construct from a protobuf message object.
</span><span class="c1"></span>  <span class="c1">/// The input message will be **copied** into this object.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// \param message The protobuf message.
</span><span class="c1"></span>  <span class="k">explicit</span> <span class="n">PythonFunctionDescriptor</span><span class="p">(</span><span class="n">rpc</span><span class="o">::</span><span class="n">FunctionDescriptor</span> <span class="n">message</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">FunctionDescriptorInterface</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">RAY_CHECK</span><span class="p">(</span><span class="n">message_</span><span class="o">-&gt;</span><span class="n">function_descriptor_case</span><span class="p">()</span> <span class="o">==</span>
              <span class="n">ray</span><span class="o">::</span><span class="n">FunctionDescriptorType</span><span class="o">::</span><span class="n">kPythonFunctionDescriptor</span><span class="p">);</span>
    <span class="n">typed_message_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">message_</span><span class="o">-&gt;</span><span class="n">python_function_descriptor</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">size_t</span> <span class="nf">Hash</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">ray</span><span class="o">::</span><span class="n">FunctionDescriptorType</span><span class="o">::</span><span class="n">kPythonFunctionDescriptor</span><span class="p">)</span> <span class="o">^</span>
           <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">())</span> <span class="o">^</span>
           <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">class_name</span><span class="p">())</span> <span class="o">^</span>
           <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">())</span> <span class="o">^</span>
           <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_hash</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kr">inline</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">PythonFunctionDescriptor</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ModuleName</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">ModuleName</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
           <span class="k">this</span><span class="o">-&gt;</span><span class="n">ClassName</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">ClassName</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
           <span class="k">this</span><span class="o">-&gt;</span><span class="n">FunctionName</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">FunctionName</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
           <span class="k">this</span><span class="o">-&gt;</span><span class="n">FunctionHash</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">FunctionHash</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kr">inline</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">PythonFunctionDescriptor</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ToString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;{type=PythonFunctionDescriptor, module_name=&#34;</span> <span class="o">+</span>
           <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">()</span> <span class="o">+</span>
           <span class="s">&#34;, class_name=&#34;</span> <span class="o">+</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">class_name</span><span class="p">()</span> <span class="o">+</span>
           <span class="s">&#34;, function_name=&#34;</span> <span class="o">+</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">()</span> <span class="o">+</span>
           <span class="s">&#34;, function_hash=&#34;</span> <span class="o">+</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_hash</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;}&#34;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CallSiteString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">CallString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CallString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">class_name</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">function_name</span> <span class="o">=</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">class_name</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">function_name</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">function_name</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">class_name</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">class_name</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span>
             <span class="n">function_name</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">function_name</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">ModuleName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">module_name</span><span class="p">();</span> <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">ClassName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">class_name</span><span class="p">();</span> <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FunctionName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">();</span> <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FunctionHash</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">typed_message_</span><span class="o">-&gt;</span><span class="n">function_hash</span><span class="p">();</span> <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="n">rpc</span><span class="o">::</span><span class="n">PythonFunctionDescriptor</span> <span class="o">*</span><span class="n">typed_message_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table></div>
</div>
</div><h3 id="heading"><a href="#heading" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a></h3>
<h2 id="gym"><a href="#gym" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>gym</h2>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">gym</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;CartPole-v0&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span> <span class="c1"># take a random action</span>
<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table></div>
</div>
</div><p>The <code>step</code> function will returns four values:</p>
<ul>
<li><strong>observation (object):</strong> an environment-specific object representing your observation of the environment. For example, pixel data from a camera, joint angles and joint velocities of a robot, or the board state in a board game.</li>
<li><strong>reward (float):</strong> amount of reward achieved by the previous action. The scale varies between environments, but the goal is always to increase your total reward.</li>
<li><strong>done (boolean)</strong>: whether it’s time to reset the environment again. Most (but not all) tasks are divided up into well-defined episodes, and done being True indicates the episode has terminated. (For example, perhaps the pole tipped too far, or you lost your last life.)</li>
<li><strong>info (dict)</strong>: diagnostic information useful for debugging. It can sometimes be useful for learning (for example, it might contain the raw probabilities behind the environment’s last state change). However, official evaluations of your agent are not allowed to use this for learning.</li>
</ul>
<p>Every environment comes with an <code>action_space</code> and an <code>observation_space</code>. These attributes are of type Space, and they describe the format of valid actions and observations:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">gym</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;CartPole-v0&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
<span class="c1">#&gt; Discrete(2)</span>
<span class="k">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="c1">#&gt; Box(4,)</span>
</code></pre></td></tr></table></div>
</div>
</div><p>The Discrete space allows a fixed range of non-negative numbers, so in this case valid actions are either 0 or 1. The Box space represents an n-dimensional box, so valid observations will be an array of 4 numbers. We can also check the Box’s bounds:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
<span class="c1">#&gt; array([ 2.4       ,         inf,  0.20943951,         inf])</span>
<span class="k">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>
<span class="c1">#&gt; array([-2.4       ,        -inf, -0.20943951,        -inf])</span>
</code></pre></td></tr></table></div>
</div>
</div><h2 id="reference"><a href="#reference" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Reference</h2>
<ol>
<li><a href="">Ray 1.0 Architecture</a></li>
<li><a href="">Ownership A Distributed Futures System for Fine-Grained Tasks</a></li>
</ol>

            </div>

        </article>

        

        
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">作者</span>：<a href="https://liudyboy.github.io/" target="_blank" rel="noopener">liudy</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">链接</span>：<a href="/posts/ray-%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://liudyboy.github.io/posts/ray-笔记/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">许可</span>：<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></li>
            
        </ul>
    



        
    <div class="updated-badge-container">
        <span title="Updated @ 2021-12-30 15:30:10 CST" style="cursor:help">

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2021-12-30</text><text x="915" y="140" textLength="650" transform="scale(.1)">2021-12-30</text></g></svg>
        </span></div>



        


        <div class="post-share">

        

        <div class="share-items">

            

            

            

            

            
                <div class="share-item weibo">
                    
                    <a href="https://service.weibo.com/share/share.php?&amp;url=https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/&amp;title=Ray%20%e7%ac%94%e8%ae%b0&amp;pic=https://liudyboy.github.io/imgs/raytest1.png&amp;searchPic=false" title="分享到「新浪微博」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a>
                </div>
            

            
                <div class="share-item douban">
                    
                    <a href="https://www.douban.com/share/service?href=https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/&amp;name=Ray%20%e7%ac%94%e8%ae%b0&amp;text=%e6%9c%ac%e6%96%87%e8%ae%b0%e5%bd%95%e6%a1%86%e6%9e%b6%20Ray%20%e7%9b%b8%e5%85%b3%e7%9a%84%e7%ac%94%e8%ae%b0" title="分享到「豆瓣」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412l-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952 0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03Z"/></svg></a>
                </div>
            

            
                <div class="share-item qq">
                    
                    <a href="https://connect.qq.com/widget/shareqq/index.html?url=https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/&amp;title=Ray%20%e7%ac%94%e8%ae%b0&amp;summary=%e6%9c%ac%e6%96%87%e8%ae%b0%e5%bd%95%e6%a1%86%e6%9e%b6%20Ray%20%e7%9b%b8%e5%85%b3%e7%9a%84%e7%ac%94%e8%ae%b0&amp;pics=https://liudyboy.github.io/imgs/raytest1.png&amp;site=liudy" title="分享到「QQ」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a>
                </div>
            

            
                <div class="share-item qzone">
                    
                    <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://liudyboy.github.io/posts/ray-%E7%AC%94%E8%AE%B0/&amp;title=Ray%20%e7%ac%94%e8%ae%b0&amp;summary=%e6%9c%ac%e6%96%87%e8%ae%b0%e5%bd%95%e6%a1%86%e6%9e%b6%20Ray%20%e7%9b%b8%e5%85%b3%e7%9a%84%e7%ac%94%e8%ae%b0&amp;pics=https://liudyboy.github.io/imgs/raytest1.png&amp;site=liudy" title="分享到「QQ 空间」" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532c-.104 0-.251.051-.349.238-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477 0 0 0 .125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061c.103-.017.201.061.201.061s6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463 0 0 0 .159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5 0 0 1 2.861-2.155c1.285-.968 3.559-2.47 3.559-2.731 0-.285-2.144-.781-4.037-.781-1.945 0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276 0 .342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688 0 .342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477 0 0 0 .127-.449z"/></svg></a>
                </div>
            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="通过「二维码」"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/liudyboy.github.io\/posts\/ray-%E7%AC%94%E8%AE%B0\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">相关文章：<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/gflags-note/" class="related-link">Gflags Note</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/glog-note/" class="related-link">GLOG Note</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/petsc%E7%9A%84%E4%BD%BF%E7%94%A8/" class="related-link">PETSc的使用</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/awesome-library/" class="related-link">Awesome Library</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/bazel-note/" class="related-link">Bazel Note</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/library/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>library</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/pythons-note/" rel="prev">&lt; Pythons Note</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/git-%E4%BD%BF%E7%94%A8/" rel="next">Git 使用 &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2020–2022&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;liudy</div><div class="site-copyright"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="mailto:liudy95@126.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/liudyboy" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        
    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>

<script>
    var scroll = new SmoothScroll('a[href*="#"]', {
        speedAsDuration: true,
        header: '[data-scroll-header]'
    });
</script>






    <script>
    if (typeof MathJax === 'undefined') {
        window.MathJax = {
            loader: {
                load: ['[tex]/mhchem']
            },
            
            tex: {
                inlineMath: {'[+]': [['$', '$']]},
                tags: 'ams',
                packages: {'[+]': ['mhchem']}
            }
        };
        (function() {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js';
            script.defer = true;
            document.head.appendChild(script);
        })();
    } else {
        MathJax.texReset();
        MathJax.typeset();
    }
</script>








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.min.js" type="module" defer></script>







    
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    




    </body>
</html>
